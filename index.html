<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus Weather</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 640 512' fill='%233B82F6'><path d='M537.6 226.6c4.1-10.7 6.4-22.4 6.4-34.6 0-53-43-96-96-96-19.7 0-38.1 6-53.3 16.2C367 64.2 315.3 32 256 32c-88.4 0-160 71.6-160 160 0 2.7.1 5.4.2 8.1C40.2 219.8 0 273.2 0 336c0 79.5 64.5 144 144 144h368c70.7 0 128-57.3 128-128 0-61.9-44-113.6-102.4-125.4z'/></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Dark background */
            color: #E5E7EB; /* Light text */
        }
        .weather-card {
            background: rgba(31, 41, 55, 0.5); /* Semi-transparent dark card */
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .search-bar:focus {
            box-shadow: 0 0 0 2px #3B82F6;
            outline: none;
        }
        /* Custom scrollbar for a better look */
        .hourly-forecast::-webkit-scrollbar {
            height: 6px;
        }
        .hourly-forecast::-webkit-scrollbar-track {
            background: #1F2937;
            border-radius: 10px;
        }
        .hourly-forecast::-webkit-scrollbar-thumb {
            background: #4B5563;
            border-radius: 10px;
        }
        .hourly-forecast::-webkit-scrollbar-thumb:hover {
            background: #6B7280;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4 bg-gray-900">
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-50">
        <div class="loader"></div>
    </div>

    <main id="weather-container" class="w-full max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8 hidden">
        <!-- Left Column: Main Weather Display -->
        <div class="lg:col-span-2 space-y-8">
            <!-- Search and Location -->
            <div class="flex flex-col sm:flex-row gap-4">
                <form id="search-form" class="flex-grow">
                    <div class="relative">
                        <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        <input type="text" id="city-input" placeholder="Search for a city..." class="search-bar w-full bg-gray-800 border border-gray-700 rounded-full py-3 pl-12 pr-4 text-white placeholder-gray-400 transition-all duration-300">
                    </div>
                </form>
                <button id="current-location-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-full transition-colors duration-300 flex items-center justify-center gap-2">
                    <i class="fas fa-location-crosshairs"></i>
                    <span>Current Location</span>
                </button>
            </div>

            <!-- Current Weather -->
            <div class="weather-card p-8 rounded-3xl">
                <div class="flex flex-col sm:flex-row justify-between items-start">
                    <div>
                        <h2 id="city-name" class="text-3xl font-bold">--</h2>
                        <p id="current-date" class="text-gray-400">--</p>
                        <p id="local-time" class="text-2xl font-semibold text-blue-300 mt-2">--:--:--</p>
                        <p id="weather-description" class="text-lg capitalize mt-4">--</p>
                    </div>
                    <div class="text-center mt-6 sm:mt-0">
                        <div id="weather-icon" class="text-7xl mb-2"></div>
                        <p id="current-temp" class="text-6xl font-bold">--°</p>
                    </div>
                </div>
            </div>

            <!-- Hourly Forecast -->
            <div class="weather-card p-6 rounded-3xl">
                <h3 class="text-xl font-semibold mb-4">Hourly Forecast</h3>
                <div id="hourly-forecast-container" class="hourly-forecast flex space-x-6 overflow-x-auto pb-4">
                    <!-- Hourly items will be injected here -->
                </div>
            </div>
        </div>

        <!-- Right Column: Details and Daily Forecast -->
        <div class="lg:col-span-1 space-y-8">
            <!-- Weather Details -->
            <div class="weather-card p-6 rounded-3xl">
                <h3 class="text-xl font-semibold mb-4">Weather Details</h3>
                <div class="grid grid-cols-2 gap-4 text-lg">
                    <div class="flex items-center gap-3">
                        <i class="fas fa-temperature-high text-blue-400 w-6 text-center"></i>
                        <div>
                            <p class="text-gray-400 text-sm">Feels Like</p>
                            <p id="feels-like" class="font-semibold">--°</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <i class="fas fa-wind text-blue-400 w-6 text-center"></i>
                        <div>
                            <p class="text-gray-400 text-sm">Wind</p>
                            <p id="wind-speed" class="font-semibold">-- m/s</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <i class="fas fa-droplet text-blue-400 w-6 text-center"></i>
                        <div>
                            <p class="text-gray-400 text-sm">Humidity</p>
                            <p id="humidity" class="font-semibold">--%</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <i class="fas fa-eye text-blue-400 w-6 text-center"></i>
                        <div>
                            <p class="text-gray-400 text-sm">Visibility</p>
                            <p id="visibility" class="font-semibold">-- km</p>
                        </div>
                    </div>
                     <div class="flex items-center gap-3">
                        <i class="fas fa-sun text-yellow-400 w-6 text-center"></i>
                        <div>
                            <p class="text-gray-400 text-sm">Sunrise</p>
                            <p id="sunrise" class="font-semibold">--:--</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <i class="fas fa-moon text-gray-400 w-6 text-center"></i>
                        <div>
                            <p class="text-gray-400 text-sm">Sunset</p>
                            <p id="sunset" class="font-semibold">--:--</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 5-Day Forecast -->
            <div class="weather-card p-6 rounded-3xl">
                <h3 class="text-xl font-semibold mb-4">5-Day Forecast</h3>
                <div id="daily-forecast-container" class="space-y-3">
                    <!-- Daily items will be injected here -->
                </div>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Element References ---
            const cityInput = document.getElementById('city-input');
            const searchForm = document.getElementById('search-form');
            const currentLocationBtn = document.getElementById('current-location-btn');
            const loadingOverlay = document.getElementById('loading-overlay');
            const weatherContainer = document.getElementById('weather-container');
            
            // --- API Configuration ---
            const API_KEY = 'bb822811edbdb82c5435dd95cc08c243';

            // --- Clock Interval ---
            let clockInterval = null;

            // --- Weather Icon Mapping ---
            const weatherIconMap = {
                '01d': '<i class="fas fa-sun text-yellow-400"></i>', '01n': '<i class="fas fa-moon text-gray-300"></i>',
                '02d': '<i class="fas fa-cloud-sun text-yellow-400"></i>', '02n': '<i class="fas fa-cloud-moon text-gray-300"></i>',
                '03d': '<i class="fas fa-cloud text-gray-400"></i>', '03n': '<i class="fas fa-cloud text-gray-400"></i>',
                '04d': '<i class="fas fa-cloud-meatball text-gray-500"></i>', '04n': '<i class="fas fa-cloud-meatball text-gray-500"></i>',
                '09d': '<i class="fas fa-cloud-showers-heavy text-blue-400"></i>', '09n': '<i class="fas fa-cloud-showers-heavy text-blue-400"></i>',
                '10d': '<i class="fas fa-cloud-sun-rain text-blue-400"></i>', '10n': '<i class="fas fa-cloud-moon-rain text-blue-400"></i>',
                '11d': '<i class="fas fa-bolt text-yellow-500"></i>', '11n': '<i class="fas fa-bolt text-yellow-500"></i>',
                '13d': '<i class="fas fa-snowflake text-cyan-300"></i>', '13n': '<i class="fas fa-snowflake text-cyan-300"></i>',
                '50d': '<i class="fas fa-smog text-gray-500"></i>', '50n': '<i class="fas fa-smog text-gray-500"></i>',
            };

            // --- Utility Functions ---
            const showLoader = () => {
                loadingOverlay.style.display = 'flex';
                weatherContainer.classList.add('hidden');
            };
            const hideLoader = () => {
                loadingOverlay.style.display = 'none';
                weatherContainer.classList.remove('hidden');
            };

            const getWeatherData = async (city) => {
                showLoader();
                try {
                    const weatherUrl = `https://api.openweathermap.org/data/2.5/weather?q=${city}&appid=${API_KEY}&units=metric`;
                    const forecastUrl = `https://api.openweathermap.org/data/2.5/forecast?q=${city}&appid=${API_KEY}&units=metric`;

                    const [weatherResponse, forecastResponse] = await Promise.all([
                        fetch(weatherUrl),
                        fetch(forecastUrl)
                    ]);

                    if (!weatherResponse.ok) {
                        throw new Error(`City not found: ${city}`);
                    }

                    const weatherData = await weatherResponse.json();
                    const forecastData = await forecastResponse.json();
                    
                    updateUI(weatherData, forecastData);
                } catch (error) {
                    console.error("Error fetching weather data:", error);
                    alert("Could not fetch weather data. Please check the city name and try again.");
                } finally {
                    hideLoader();
                }
            };
            
            const getWeatherDataByCoords = async (lat, lon) => {
                showLoader();
                try {
                    const weatherUrl = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${API_KEY}&units=metric`;
                    const forecastUrl = `https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&appid=${API_KEY}&units=metric`;

                    const [weatherResponse, forecastResponse] = await Promise.all([
                        fetch(weatherUrl),
                        fetch(forecastUrl)
                    ]);

                    if (!weatherResponse.ok) {
                        throw new Error(`Could not fetch weather for coordinates.`);
                    }

                    const weatherData = await weatherResponse.json();
                    const forecastData = await forecastResponse.json();
                    
                    updateUI(weatherData, forecastData);
                } catch (error) {
                    console.error("Error fetching weather data by coords:", error);
                    alert("Could not fetch weather data for your location.");
                } finally {
                    hideLoader();
                }
            };

            // --- UI Update Functions ---
            const updateUI = (weather, forecast) => {
                updateCurrentWeather(weather);
                updateHourlyForecast(forecast);
                updateDailyForecast(forecast);
            };

            const updateClock = (timezoneOffset) => {
                const clockElement = document.getElementById('local-time');
                if (!clockElement) return;

                // Clear previous clock interval to prevent multiple clocks running
                if (clockInterval) {
                    clearInterval(clockInterval);
                }

                clockInterval = setInterval(() => {
                    const now = new Date();
                    // Get the current UTC time in milliseconds
                    const utcMillis = now.getTime() + (now.getTimezoneOffset() * 60000);
                    // Calculate the local time for the city using the UTC offset from the API
                    const cityLocalTime = new Date(utcMillis + (timezoneOffset * 1000));

                    clockElement.textContent = cityLocalTime.toLocaleTimeString('en-US', {
                        hour: 'numeric',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: true
                    });
                }, 1000);
            };

            const updateCurrentWeather = (data) => {
                document.getElementById('city-name').textContent = `${data.name}, ${data.sys.country}`;
                document.getElementById('current-date').textContent = new Date().toLocaleDateString('en-US', {
                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
                });
                document.getElementById('weather-description').textContent = data.weather[0].description;
                document.getElementById('weather-icon').innerHTML = weatherIconMap[data.weather[0].icon] || '';
                document.getElementById('current-temp').textContent = `${Math.round(data.main.temp)}°`;
                document.getElementById('feels-like').textContent = `${Math.round(data.main.feels_like)}°`;
                document.getElementById('wind-speed').textContent = `${data.wind.speed.toFixed(1)} m/s`;
                document.getElementById('humidity').textContent = `${data.main.humidity}%`;
                document.getElementById('visibility').textContent = `${(data.visibility / 1000).toFixed(1)} km`;

                const sunriseTime = new Date(data.sys.sunrise * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const sunsetTime = new Date(data.sys.sunset * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                document.getElementById('sunrise').textContent = sunriseTime;
                document.getElementById('sunset').textContent = sunsetTime;

                // Update the clock with the new location's timezone
                updateClock(data.timezone);
            };

            const updateHourlyForecast = (data) => {
                const container = document.getElementById('hourly-forecast-container');
                container.innerHTML = '';
                const hourlyData = data.list.slice(0, 8); // Get next 8 3-hour forecasts

                hourlyData.forEach(item => {
                    const hour = new Date(item.dt * 1000).toLocaleTimeString([], { hour: '2-digit', hour12: true });
                    const temp = Math.round(item.main.temp);
                    const icon = weatherIconMap[item.weather[0].icon] || '';

                    const hourlyItem = `
                        <div class="flex flex-col items-center space-y-2 flex-shrink-0">
                            <p class="text-gray-400">${hour}</p>
                            <div class="text-3xl">${icon}</div>
                            <p class="font-semibold">${temp}°</p>
                        </div>
                    `;
                    container.innerHTML += hourlyItem;
                });
            };

            const updateDailyForecast = (data) => {
                const container = document.getElementById('daily-forecast-container');
                container.innerHTML = '';
                
                // Process data to get one forecast per day
                const dailyForecasts = {};
                data.list.forEach(item => {
                    const date = new Date(item.dt * 1000).toLocaleDateString('en-CA'); // YYYY-MM-DD format for easy keying
                    if (!dailyForecasts[date]) {
                        dailyForecasts[date] = {
                            temps: [],
                            icons: {},
                            description: ''
                        };
                    }
                    dailyForecasts[date].temps.push(item.main.temp);
                    const icon = item.weather[0].icon;
                    dailyForecasts[date].icons[icon] = (dailyForecasts[date].icons[icon] || 0) + 1;

                    // Use the weather description from around midday
                    if (new Date(item.dt * 1000).getHours() >= 11 && new Date(item.dt * 1000).getHours() <= 14) {
                        dailyForecasts[date].description = item.weather[0].description;
                    }
                });

                // Create and append daily forecast elements
                Object.keys(dailyForecasts).slice(0, 5).forEach(date => {
                    const dayData = dailyForecasts[date];
                    const dayName = new Date(date).toLocaleDateString('en-US', { weekday: 'long' });
                    const maxTemp = Math.round(Math.max(...dayData.temps));
                    const minTemp = Math.round(Math.min(...dayData.temps));
                    const mostFrequentIcon = Object.keys(dayData.icons).reduce((a, b) => dayData.icons[a] > dayData.icons[b] ? a : b);
                    const iconHTML = weatherIconMap[mostFrequentIcon] || '';
                    
                    const dailyItem = `
                        <div class="flex items-center justify-between">
                            <p class="w-1/3 text-gray-300">${dayName}</p>
                            <div class="w-1/3 flex items-center justify-center gap-2">
                                <span class="text-2xl">${iconHTML}</span>
                            </div>
                            <p class="w-1/3 text-right font-semibold">
                                <span class="text-white">${maxTemp}°</span> / 
                                <span class="text-gray-400">${minTemp}°</span>
                            </p>
                        </div>
                    `;
                    container.innerHTML += dailyItem;
                });
            };

            // --- Event Listeners ---
            searchForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const city = cityInput.value.trim();
                if (city) {
                    getWeatherData(city);
                    cityInput.value = '';
                }
            });

            currentLocationBtn.addEventListener('click', () => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const { latitude, longitude } = position.coords;
                            getWeatherDataByCoords(latitude, longitude);
                        },
                        (error) => {
                            console.error("Geolocation error:", error);
                            alert("Unable to retrieve your location. Showing weather for London.");
                            getWeatherData('London'); // Fallback city
                        }
                    );
                } else {
                    alert("Geolocation is not supported by your browser. Showing weather for London.");
                    getWeatherData('London'); // Fallback city
                }
            });

            // --- Initial Load ---
            // Trigger current location on load for a seamless experience
            currentLocationBtn.click();
        });
    </script>
</body>
</html>
